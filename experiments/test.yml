# Author: Michael Sevilla
# Create a Tachyon development node (with the source code)

#- hosts: localhost
#  roles: [emaster]
#  tasks: 
#    - name: pull the tachyon code
#      include: ../roles/tachyon/tasks/get_src.yml
#
#    - name: configure tachyon
#      include: ../roles/tachyon/tasks/config.yml
#
#    - name: check to see if we already packaged the code
#      stat: path={{ tmpdir }}/tachyon.tar.gz
#      register: p
#
#    - name: package the code 
#      shell: cd {{ tmpdir }}; tar czvf tachyon.tar.gz tachyon
#      when: p.stat.exists == False
#
#    - name: delete all evidence
#      file: path={{ tmpdir }}/tachyon state=absent



- name: initialize provisioning
  hosts: all
  gather_facts: no
  roles: [tachyon]
  tasks:
    #- name: put the code over there
    #  unarchive: src={{ tmpdir }}/tachyon.tar.gz 
    #             dest={{ tmpdir }}/

    - name: pull/install a tachyon container
      docker:
        image: michaelsevilla/hathisar-dev:tachyon
        name: tachyon
        detach: yes
        tty: yes
        env:
          SSHD_PORT: 2222
          AUTHORIZED_KEYS: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
          #AUTHORIZED_KEYS: 'bogus ssh key'
        net: host
        volumes: /tmp/docker/tachyon:/tachyon
        privileged: yes
        state: started

    - add_host: name={{ inventory_hostname }} ansible_ssh_port=2222 group=just_created ansible_ssh_user=root 

- name: test some hostname stuff
  hosts: just_created
#  gather_facts: no
  tasks: 
#    - debug: msg='the hostname is {{ inventory_hostname }} {{ ansible_ssh_port }}'
#    #- shell: /tachyon/bin/tachyon-start.sh master -f
    - shell: ls
